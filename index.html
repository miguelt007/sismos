<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Sismos IPMA em tempo real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 20px; }
    header { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    label { font-weight: 600; }
    input, select { padding: 6px 8px; }
    .status { font-size: 0.9rem; opacity: 0.8; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    thead th { position: sticky; top: 0; background: #f3f3f3; color: #222; z-index: 1; }
    th, td { border-bottom: 1px solid #e5e5e5; padding: 8px; text-align: left; vertical-align: top; }
    tbody tr:hover { background: #f9f9f9; }
    .muted { opacity: 0.7; font-size: 0.9em; }
    .error { color: #b00020; }
    .controls { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .chip { display: inline-block; padding: 2px 6px; border-radius: 6px; background: #eef; color: #224; font-size: 0.85em; margin-left: 6px;}
    .highlight-mag { background-color: #ffe0cc; }
    .highlight-recent { background-color: #e0f0ff; }
    .highlight-both { background-color: #f0e0ff; }
    .highlight-mag td,
    .highlight-recent td,
    .highlight-both td {
      color: #111;
    }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;">Sismicidade IPMA <span class="chip">tempo real</span></h1>
  </header>

  <div class="controls">
    <div>
      <label for="interval">Atualizar a cada</label>
      <select id="interval">
        <option value="10000">10 s</option>
        <option value="15000">15 s</option>
        <option value="30000" selected>30 s</option>
        <option value="60000">1 min</option>
        <option value="120000">2 min</option>
      </select>
    </div>
    <div>
      <label for="minMag">Magnitude m√≠nima</label>
      <input id="minMag" type="number" step="0.1" value="0" style="width: 6rem;" />
    </div>
    <div class="status" id="status" title="Clique para atualizar j√°">Pronto</div>
  </div>

  <div id="error" class="error" role="alert" style="display:none;"></div>

  <div style="overflow:auto; max-width: 100%;">
    <table id="table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'https://api.ipma.pt/open-data/observation/seismic/7.json';
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const table = document.getElementById('table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const intervalSel = document.getElementById('interval');
    const minMagInput = document.getElementById('minMag');

    let timer = null;
    let lastSignature = '';

    function isLikelyDateKey(key) {
      const k = key.toLowerCase();
      return ['time','date','datetime','instant','origin','obs_time','tempo','data'].some(s => k.includes(s));
    }

    function parseDate(value) {
      if (value == null) return null;
      if (typeof value === 'number') {
        const ms = value > 1e12 ? value : value * 1000;
        const d = new Date(ms);
        return isNaN(d) ? null : d;
      }
      if (typeof value === 'string') {
        const d = new Date(value);
        return isNaN(d) ? null : d;
      }
      return null;
    }

    function formatValue(key, value, row) {
      if (value == null) return '';
      if (isLikelyDateKey(key)) {
        const d = parseDate(value);
        if (d) return d.toLocaleString('pt-PT', { timeZone: 'Europe/Lisbon', hour12: false });
      }
      if (typeof value === 'number') {
        const k = key.toLowerCase();
        if (k.includes('mag')) return value.toFixed(1);
        if (k.includes('depth') || k.includes('prof')) return value.toFixed(value % 1 === 0 ? 0 : 1);
        return Number.isInteger(value) ? value.toString() : value.toFixed(2);
      }
      if (Array.isArray(value)) return value.join(', ');
      if (typeof value === 'object') return JSON.stringify(value);
      return String(value);
    }

    function deriveItems(json) {
      if (Array.isArray(json)) return json;
      if (json && Array.isArray(json.data)) return json.data;
      if (json && Array.isArray(json.features)) return json.features.map(f => f.properties ?? f);
      return [];
    }

    function buildColumns(items) {
      const N = Math.min(items.length, 50);
      const set = new Set();
      for (let i = 0; i < N; i++) Object.keys(items[i]).forEach(k => set.add(k));
      const cols = Array.from(set);
      const priority = ['time','date','datetime','instant','obs_time','mag','magnitude','lat','latitude','lon','lng','longitude','depth','prof'];
      cols.sort((a, b) => {
        const ai = priority.findIndex(p => a.toLowerCase().includes(p));
        const bi = priority.findIndex(p => b.toLowerCase().includes(p));
        const av = ai === -1 ? Number.POSITIVE_INFINITY : ai;
        const bv = bi === -1 ? Number.POSITIVE_INFINITY : bi;
        return av - bv || a.localeCompare(b);
      });
      return cols;
    }

    function renderTable(items) {
      if (!items.length) {
        thead.innerHTML = '';
        tbody.innerHTML = '<tr><td class="muted">Sem dados</td></tr>';
        return;
      }
      const cols = buildColumns(items);
      const magKey = cols.find(k => k.toLowerCase().includes('mag'));
      const timeKey = cols.find(isLikelyDateKey);

      items.sort((a, b) => {
        const da = parseDate(a[timeKey])?.getTime() ?? -Infinity;
        const db = parseDate(b[timeKey])?.getTime() ?? -Infinity;
        return db - da;
      });

      thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';
      tbody.innerHTML = items.map(row => {
        const mag = magKey ? parseFloat(row[magKey]) : null;
        const time = timeKey ? parseDate(row[timeKey]) : null;
        const now = Date.now();
        const isStrong = mag != null && mag >= 3.0;
        const isRecent = time != null && (now - time.getTime()) <= 3600_000;

        let highlightClass = '';
        let emoji = '';
        if (isStrong && isRecent) {
          highlightClass = 'highlight-both';
          emoji = 'üî¥‚è∞ ';
        } else if (isStrong) {
          highlightClass = 'highlight-mag';
          emoji = 'üî¥ ';
        } else if (isRecent) {
          highlightClass = 'highlight-recent';
          emoji = '‚è∞ ';
        }

        return `<tr class="${highlightClass}">` +
               cols.map(c => `<td>${c === timeKey ? emoji : ''}${formatValue(c, row[c], row)}</td>`).join('') +
               '</tr>';
      }).join('');
    }

    function filterByMinMag(items, minMag) {
      if (!isFinite(minMag) || minMag <= 0) return items;
      const guessMagKey = items.length ? Object.keys(items[0]).find(k => k.toLowerCase().includes('mag')) : null;
      if (!guessMagKey) return items;
      return items.filter(item => {
        const mag = parseFloat(item[guessMagKey]);
        return isFinite(mag) && mag >= minMag;
      });
    }

        async function fetchData() {
      try {
        statusEl.textContent = 'A atualizar...';
        errorEl.style.display = 'none';

        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
        const json = await res.json();

        const items = deriveItems(json);
        const filtered = filterByMinMag(items, parseFloat(minMagInput.value));
        const signature = JSON.stringify(filtered.map(i => i.id || i.time || i.mag || i.lat || i.lon));

        if (signature !== lastSignature) {
          renderTable(filtered);
          lastSignature = signature;
        }

        const now = new Date();
        statusEl.textContent = `Atualizado √†s ${now.toLocaleTimeString('pt-PT', { hour12: false })}`;
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Erro ao obter dados: ' + err.message;
        errorEl.style.display = 'block';
        statusEl.textContent = 'Erro';
      }
    }

    function startAutoUpdate() {
      if (timer) clearInterval(timer);
      const ms = parseInt(intervalSel.value);
      timer = setInterval(fetchData, ms);
    }

    intervalSel.addEventListener('change', startAutoUpdate);
    minMagInput.addEventListener('input', fetchData);
    statusEl.addEventListener('click', fetchData);

    // Inicializa√ß√£o
    fetchData();
    startAutoUpdate();
  </script>
</body>
</html>

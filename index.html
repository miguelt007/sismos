<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Sismos IPMA</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f0f0f0; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    th { background: #eee; }
    tr.highlight { background: #ffe0e0; font-weight: bold; }
    #status { margin-top: 1em; cursor: pointer; color: blue; }
    #error { color: red; display: none; margin-top: 0.5em; }
  </style>
</head>
<body>
  <h1>Sismos IPMA</h1>
  <label>Intervalo atualizaÃ§Ã£o:
    <select id="interval">
      <option value="60000">1 min</option>
      <option value="300000">5 min</option>
      <option value="900000">15 min</option>
    </select>
  </label>
  <label style="margin-left: 1em;">Magnitude mÃ­nima:
    <input type="number" id="minMag" value="0" step="0.1" min="0">
  </label>
  <div id="status">Atualizar ðŸ”„</div>
  <div id="error"></div>
  <table id="table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Local</th>
        <th>Mag</th>
        <th>Lat</th>
        <th>Lon</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = 'https://www.ipma.pt/resources.www/sismo/sismos.json';
    const tableBody = document.querySelector('#table tbody');
    const intervalSel = document.querySelector('#interval');
    const minMagInput = document.querySelector('#minMag');
    const statusEl = document.querySelector('#status');
    const errorEl = document.querySelector('#error');

    let timer = null;
    let lastSignature = '';

    function deriveItems(json) {
      if (!json || !json.features) return [];

      const items = json.features.map(f => {
        const props = f.properties || {};
        const coords = f.geometry?.coordinates || [];

        return {
          id: f.id || `${props.time}`,
          mag: parseFloat(props.mag?.toString().replace(',', '.')),
          place: props.place || 'Local desconhecido',
          time: props.time ? new Date(props.time) : null,
          lat: coords[1] || null,
          lon: coords[0] || null
        };
      }).filter(item => item.time && !isNaN(item.mag));

      items.sort((a, b) => b.time - a.time);
      return items;
    }

    function filterByMinMag(items, minMag) {
      if (isNaN(minMag)) return items;

      return items.filter(item => item.mag >= minMag);
    }

    function renderTable(items) {
      tableBody.innerHTML = '';

      items.forEach(item => {
        const tr = document.createElement('tr');
        if (item.mag >= 3.5) tr.classList.add('highlight');

        tr.innerHTML = `
          <td>${item.time.toLocaleString('pt-PT', { hour12: false })}</td>
          <td>${item.place}</td>
          <td>${item.mag.toFixed(1)}</td>
          <td>${item.lat?.toFixed(2)}</td>
          <td>${item.lon?.toFixed(2)}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function fetchData() {
      try {
        statusEl.textContent = 'A atualizar...';
        errorEl.style.display = 'none';

        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
        const json = await res.json();

        const items = deriveItems(json);
        const filtered = filterByMinMag(items, parseFloat(minMagInput.value));
        const signature = JSON.stringify(filtered.map(i => i.id || i.time || i.mag || i.lat || i.lon));

        if (signature !== lastSignature) {
          renderTable(filtered);
          lastSignature = signature;
        }

        const now = new Date();
        statusEl.textContent = `Atualizado Ã s ${now.toLocaleTimeString('pt-PT', { hour12: false })}`;
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Erro ao obter dados: ' + err.message;
        errorEl.style.display = 'block';
        statusEl.textContent = 'Erro';
      }
    }

    function startAutoUpdate() {
      if (timer) clearInterval(timer);
      const ms = parseInt(intervalSel.value);
      timer = setInterval(fetchData, ms);
    }

    intervalSel.addEventListener('change', startAutoUpdate);
    minMagInput.addEventListener('input', fetchData);
    statusEl.addEventListener('click', fetchData);

    fetchData();
    startAutoUpdate();
  </script>
</body>
</html>
